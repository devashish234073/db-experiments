AWSTemplateFormatVersion: '2010-09-09'
Description: Cassandra instance optimized for query: SELECT * FROM data WHERE userId=? AND dob=? ORDER BY loginDate

Resources:
  MyVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: True

  MyInternetGateway:
    Type: AWS::EC2::InternetGateway

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref MyVPC
      InternetGatewayId: !Ref MyInternetGateway

  MyPublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MyVPC
      CidrBlock: 10.0.0.0/24
      MapPublicIpOnLaunch: True

  MyRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref MyVPC

  PublicRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref MyRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref MyInternetGateway

  SubnetAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref MyPublicSubnet
      RouteTableId: !Ref MyRouteTable

  MySecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow SSH, Cassandra (9042), Node.js (3000)
      VpcId: !Ref MyVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 3000
          ToPort: 3000
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 9042
          ToPort: 9042
          CidrIp: 0.0.0.0/0

  CassandraInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.small
      ImageId: ami-03f4878755434977f # Ubuntu 22.04 LTS (us-east-1)
      SubnetId: !Ref MyPublicSubnet
      SecurityGroupIds:
        - !Ref MySecurityGroup
      Tags:
        - Key: Name
          Value: CassandraOptimized
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -eux

          # Install dependencies
          apt-get update
          apt-get install -y openjdk-11-jdk curl git

          # Install Node.js 20
          curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
          apt-get install -y nodejs

          # Add Apache Cassandra 4.1 repo
          echo "deb https://debian.cassandra.apache.org 41x main" > /etc/apt/sources.list.d/cassandra.list
          curl -fsSL https://downloads.apache.org/cassandra/KEYS | gpg --dearmor -o /etc/apt/trusted.gpg.d/cassandra.gpg
          apt-get update
          apt-get install -y cassandra
          systemctl enable --now cassandra

          # Wait for Cassandra
          for i in {1..120}; do
            if nc -z localhost 9042; then break; fi
            sleep 2
          done

          # Clone app
          sudo -u ubuntu git clone https://github.com/devashish234073/db-experiments.git /home/ubuntu/db-experiments
          cd /home/ubuntu/db-experiments/cassandra-data-modelling

          # Initialize schema
          cqlsh -f init-cassandra.cql

          # Install Node.js deps
          sudo -u ubuntu npm install

          # Start app
          sudo -u ubuntu nohup node app.js > /home/ubuntu/app.log 2>&1 &

Outputs:
  CassandraAppURL:
    Description: URL to access the Cassandra login app
    Value: !Sub 'http://${CassandraInstance.PublicIp}:3000'